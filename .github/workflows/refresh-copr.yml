name: Refresh Copr SRPM
permissions:
  contents: read

on:
  schedule:
    - cron: "0 5 * * *"
  workflow_dispatch:

jobs:
  copr:
    runs-on: ubuntu-latest
    container: fedora:latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # On Fedora container we can use dnf
          dnf install -y \
            rpm \
            rpm-build \
            rpmdevtools \
            copr-cli \
            jq \
            curl

      - name: Set up rpmbuild tree
        run: |
          mkdir -p ~/.cache-builds/rpmbuild/{SOURCES,SRPMS,SPECS,BUILD,RPMS}
          echo '%_topdir %(echo $HOME)/.cache-builds/rpmbuild' > ~/.rpmmacros

      - name: Refresh sources
        working-directory: copr
        run: |
          ./refresh-sources.sh
          cp SOURCES/*.rpm ~/.cache-builds/rpmbuild/SOURCES/

      - name: Build SRPM
        working-directory: copr
        run: |
          ver=$(basename ~/.cache-builds/rpmbuild/SOURCES/vesktop-*.x86_64.rpm .x86_64.rpm | cut -d- -f2)
          rpmbuild -bs vesktop.spec --define "version_override $ver"

      - name: Push to Copr
        env:
          COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
          COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
        run: |
          srpm=$(ls ~/.cache-builds/rpmbuild/SRPMS/vesktop-*.src.rpm | tail -1)
          copr-cli build vesktop "$srpm"
